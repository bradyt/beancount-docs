<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Beancount Design Doc - beancount docs</title>
        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="..">beancount docs</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="..">Index</a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Outline <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#">Documentation for Users</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../01_command_line_accounting_in_context/">Command Line Accounting in Context</a>
</li>
            
<li >
    <a href="../02_the_double_entry_counting_method/">The Double Entry Counting Method</a>
</li>
            
<li >
    <a href="../03_installing_beancount/">Installing Beancount</a>
</li>
            
<li >
    <a href="../04_running_beancount_and_generating_reports/">Running Beancount and Generating Reports</a>
</li>
            
<li >
    <a href="../05_getting_started_with_beancount/">Getting Started with Beancount</a>
</li>
            
<li >
    <a href="../06_beancount_language_syntax/">Beancount Language Syntax</a>
</li>
            
<li >
    <a href="../07_beancount_options_reference/">Beancount Options Reference</a>
</li>
            
<li >
    <a href="../08_precision_tolerances/">Precision Tolerances</a>
</li>
            
<li >
    <a href="../09_beancount_query_language/">Beancount Query Language</a>
</li>
            
<li >
    <a href="../10_beancount_cheat_sheet/">Beancount Cheat Sheet</a>
</li>
            
<li >
    <a href="../11_how_inventories_work/">How Inventories Work</a>
</li>
            
<li >
    <a href="../12_exporting_your_portfolio/">Exporting Your Portfolio</a>
</li>
            
<li >
    <a href="../13_tutorial_example/">Tutorial & Example</a>
</li>
            
<li >
    <a href="../14_beancount_history_and_credits/">Beancount History and Credits</a>
</li>
            
<li >
    <a href="../15_a_comparison_of_beancount_and_ledger_hledger/">A Comparison of Beancount and Ledger Hledger</a>
</li>
            
<li >
    <a href="../16_fetching_prices_in_beancount/">Fetching Prices in Beancount</a>
</li>
            
<li >
    <a href="../17_importing_external_data/">Importing External Data</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Cookbooks & Examples</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../18_command_line_accounting_cookbook/">Command Line Accounting Cookbook</a>
</li>
            
<li >
    <a href="../19_trading_with_beancount/">Trading with Beancount</a>
</li>
            
<li >
    <a href="../20_stock_vesting_in_beancount/">Stock Vesting in Beancount</a>
</li>
            
<li >
    <a href="../21_sharing_expenses_with_beancount/">Sharing Expenses with Beancount</a>
</li>
            
<li >
    <a href="../22_how_we_share_expenses/">How We Share Expenses</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Documentation for Developers</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../23_beancount_scripting_plugins/">Beancount Scripting Plugins</a>
</li>
            
<li class="active">
    <a href="./">Beancount Design Doc</a>
</li>
            
<li >
    <a href="../25_ledgerhub_design_doc/">Ledgerhub Design Doc</a>
</li>
            
<li >
    <a href="../26_external_contributions/">External Contributions</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Enhancement Proposals & Discussions</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../27_a_proposal_for_an_improvement_on_inventory_booking/">A Proposal for an Improvement on Inventory Booking</a>
</li>
            
<li >
    <a href="../28_settlement_dates_in_beancount/">Settlement Dates in Beancount</a>
</li>
            
<li >
    <a href="../29_balance_assertions_in_beancount/">Balance Assertions in Beancount</a>
</li>
            
<li >
    <a href="../30_fund_accounting_with_beancount/">Fund Accounting with Beancount</a>
</li>
            
<li >
    <a href="../31_rounding_precision_in_beancount/">Rounding Precision in Beancount</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li >
                                <a rel="next" href="../23_beancount_scripting_plugins/">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li >
                                <a rel="prev" href="../25_ledgerhub_design_doc/">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li>
                                <a href="https://github.com/bradyt/beancount-docs/edit/master/docs/24_beancount_design_doc.md"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#beancount-design-doc">Beancount Design Doc</a></li>
            <li><a href="#introduction">Introduction</a></li>
            <li><a href="#invariants">Invariants</a></li>
            <li><a href="#overview-of-the-codebase">Overview of the Codebase</a></li>
            <li><a href="#core-data-structures">Core Data Structures</a></li>
            <li><a href="#directives">Directives</a></li>
            <li><a href="#loader-processing-order">Loader &amp; Processing Order</a></li>
            <li><a href="#parser-implementation">Parser Implementation</a></li>
            <li><a href="#realization">Realization</a></li>
            <li><a href="#the-web-interface">The Web Interface</a></li>
            <li><a href="#the-query-interface">The Query Interface</a></li>
            <li><a href="#design-principles">Design Principles</a></li>
            <li><a href="#future-work">Future Work</a></li>
            <li><a href="#conclusion">Conclusion</a></li>
            <li><a href="#references">References</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="beancount-design-doc">Beancount Design Doc<a class="headerlink" href="#beancount-design-doc" title="Permanent link"></a></h1>
<p>Martin Blais (<a href="mailto:blais@furius.ca"><span
class="underline">blais@furius.ca</span></a>)</p>
<p><a href="http://furius.ca/beancount/doc/design-doc"><span
class="underline">http://furius.ca/beancount/doc/design-doc</span></a></p>
<p><em>A guide for developers to understand Beancount’s internals. I hope for
this document to provide a map of the main objects used in the source
code to make it easy to write scripts and plugins on top of Beancount or
even extend it.</em></p>
<blockquote>
<p><a href="#introduction"><span class="underline">Introduction</span></a></p>
<p><a href="#invariants"><span class="underline">Invariants</span></a></p>
<p><a href="#isolation-of-inputs"><span class="underline">Isolation of
Inputs</span></a></p>
<p><a href="#order-independence"><span
class="underline">Order-Independence</span></a></p>
<p><a href="#all-transactions-must-balance"><span class="underline">All Transactions Must
Balance</span></a></p>
<p><a href="#accounts-have-types"><span class="underline">Account Have
Types</span></a></p>
<p><a href="#account-lifetimes-open-directives"><span class="underline">Account Lifetimes &amp; Open
Directives</span></a></p>
<p><a href="#supports-dates-only-and-no-time"><span class="underline">Supports Dates Only (and No
Time)</span></a></p>
<p><a href="#metadata-is-for-user-data"><span class="underline">Metadata is for User
Data</span></a></p>
<p><a href="#overview-of-the-codebase"><span class="underline">Overview of the
Codebase</span></a></p>
<p><a href="#core-data-structures"><span class="underline">Core Data
Structures</span></a></p>
<p><a href="#number"><span class="underline">Number</span></a></p>
<p><a href="#commodity"><span class="underline">Commodity</span></a></p>
<p><a href="#amount"><span class="underline">Amount</span></a></p>
<p><a href="#_cb92j1m6vve0"><span class="underline">Lot</span></a></p>
<p><a href="#_i2pg9u5nyf3k"><span class="underline">Position</span></a></p>
<p><a href="#inventory"><span class="underline">Inventory</span></a></p>
<p><a href="#account"><span class="underline">Account</span></a></p>
<p><a href="#flag"><span class="underline">Flag</span></a></p>
<p><a href="#posting"><span class="underline">Posting</span></a></p>
<p><a href="#about-tuples-mutability"><span class="underline">About Tuples &amp;
Mutability</span></a></p>
<p><a href="#summary"><span class="underline">Summary</span></a></p>
<p><a href="#directives"><span class="underline">Directives</span></a></p>
<p><a href="#common-properties"><span class="underline">Common Properties</span></a></p>
<p><a href="#transactions"><span class="underline">Transactions</span></a></p>
<p><a href="#flag-1"><span class="underline">Flag</span></a></p>
<p><a href="#payee-narration"><span class="underline">Payee &amp; Narration</span></a></p>
<p><a href="#tags"><span class="underline">Tags</span></a></p>
<p><a href="#links"><span class="underline">Links</span></a></p>
<p><a href="#postings"><span class="underline">Postings</span></a></p>
<p><a href="#balancing-postings"><span class="underline">Balancing
Postings</span></a></p>
<p><a href="#elision-of-amounts"><span class="underline">Elision of
Amounts</span></a></p>
<p><a href="#stream-processing"><span class="underline">Stream Processing</span></a></p>
<p><a href="#stream-invariants"><span class="underline">Stream Invariants</span></a></p>
<p><a href="#loader-processing-order"><span class="underline">Loader &amp; Processing
Order</span></a></p>
<p><a href="#_tk1oeldrq7r2"><span class="underline">Loader Output</span></a></p>
<p><a href="#parser-implementation"><span class="underline">Parser
Implementation</span></a></p>
<p><a href="#two-stages-of-parsing-incomplete-entries"><span class="underline">Two Stages of Parsing: Incomplete
Entries</span></a></p>
<p><a href="#the-printer"><span class="underline">The Printer</span></a></p>
<p><a href="#uniqueness-hashing"><span class="underline">Uniqueness &amp;
Hashing</span></a></p>
<p><a href="#display-context"><span class="underline">Display Context</span></a></p>
<p><a href="#realization"><span class="underline">Realization</span></a></p>
<p><a href="#the-web-interface"><span class="underline">The Web Interface</span></a></p>
<p><a href="#reports-vs.-web"><span class="underline">Reports vs. Web</span></a></p>
<p><a href="#client-side-javascript"><span class="underline">Client-Side
JavaScript</span></a></p>
<p><a href="#the-query-interface"><span class="underline">The Query
Interface</span></a></p>
<p><a href="#design-principles"><span class="underline">Design Principles</span></a></p>
<p><a href="#minimize-configurability"><span class="underline">Minimize
Configurability</span></a></p>
<p><a href="#favor-code-over-dsls"><span class="underline">Favor Code over
DSLs</span></a></p>
<p><a href="#file-format-or-input-language"><span class="underline">File Format or Input
Language?</span></a></p>
<p><a href="#grammar-via-parser-generator"><span class="underline">Grammar via Parser
Generator</span></a></p>
<p><a href="#future-work"><span class="underline">Future Work</span></a></p>
<p><a href="#tagged-strings"><span class="underline">Tagged Strings</span></a></p>
<p><a href="#errors-cleanup"><span class="underline">Errors Cleanup</span></a></p>
<p><a href="#types"><span class="underline">Types</span></a></p>
<p><a href="#conclusion"><span class="underline">Conclusion</span></a></p>
</blockquote>
<h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link"></a></h2>
<p>This document describes the principles behind the design of Beancount
and a high-level overview of its codebase, data structures, algorithms,
implementation and methodology. This is not a user's manual; if you are
interested in just using Beancount, see the associated <a href="../06_beancount_language_syntax/"><span
class="underline">User's Manual</span></a>
and all the other documents <a href=".."><span class="underline">available
here</span></a>.</p>
<p>However, if you just want to understand more deeply how Beancount works
this document should be very helpful. This should also be of interest to
developers. This is a place where I wrote about a lot of the ideas
behind Beancount that did not find any other venue. Expect some random
thoughts that aren’t important for users.</p>
<p>Normally one writes a design document before writing the software. I did
not do that. But I figured it would still be worthwhile to spell out
some of the ideas that led to this design here. I hope someone finds
this useful.</p>
<h2 id="invariants">Invariants<a class="headerlink" href="#invariants" title="Permanent link"></a></h2>
<h3 id="isolation-of-inputs">Isolation of Inputs<a class="headerlink" href="#isolation-of-inputs" title="Permanent link"></a></h3>
<p>Beancount should accept input <em>only</em> from the text file you provide to
its tools. In particular, it should not contact any external networked
service or open any “global” files, even just a cache of historical
prices or otherwise. This isolation is by design. Isolating the input to
a single source makes it easier to debug, reproduce and isolate problems
when they occur. This is a nice property for the tool.</p>
<p>In addition, fetching and converting external data is very messy.
External data formats can be notoriously bad, and they are too numerous
to handle all of them (handling just the most common subset would beg
the question of where to include the implementation of new converters).
Most importantly, the problems of representing the data vs. that of
fetching and converting it segment from each other very well naturally:
Beancount provides a core which allows you to ingest all the
transactional data and derive reports from it, and its syntax is the
hinge that connects it to these external repositories of transactions or
prices. It isolates itself from the ugly details of external sources of
data in this way.</p>
<h3 id="order-independence">Order-Independence<a class="headerlink" href="#order-independence" title="Permanent link"></a></h3>
<p>Beancount offers a guarantee that the ordering of its <em>directives</em> in an
input file is irrelevant to the outcome of its computations. You should
be able to organize your input text and reorder any declaration as is
most convenient for you, without having to worry about how the software
will make its calculations. This also makes it trivial to implement
inclusions of multiple files: you can just concatenate the files if you
want, and you can process them in any order.</p>
<p>Not even directives that declare accounts or commodities are required to
appear before these accounts get used in the file. All directives are
parsed and then basically <em>sorted</em> before any calculation or validation
occurs (a minor detail is that the line number is used as a secondary
key in the sorting, so that the re-ordering is stable).</p>
<p>Correspondingly, all the non-directive grammar that is in the language
is limited to either setting values with global impact (“option”,
“plugin”) or syntax-related conveniences (“pushtag”, “poptag”).</p>
<p>There is an exception:</p>
<ul>
<li>
<p>Options may have effects during the processing of the file and
    should appear at the beginning. At the moment, Beancount does not
    enforce this, e.g., by performing multiple passes of parsing, but it
    probably should.</p>
</li>
<li>
<p>What’s more, options in included files are currently ignored. You
    should put all your options in the top-level ledger file.</p>
</li>
</ul>
<h3 id="all-transactions-must-balance">All Transactions Must Balance<a class="headerlink" href="#all-transactions-must-balance" title="Permanent link"></a></h3>
<p>All transactions must balance by “weight.” There is no exception.
Beancount transactions are required to have balanced, period.</p>
<p>In particular, there is no allowance for exceptions such as the “virtual
postings” that can be seen in Ledger. The first implementation of
Beancount allowed such postings. As a result, I often used them to
“resolve” issues that I did not know how to model well otherwise. When I
rewrote Beancount, I set out to convert my entire input file to avoid
using these, and over time I succeeded in doing this and learned a lot
of new things in the process. I have since become convinced that virtual
postings are wholly unnecessary, and that make them available only
provides a <em>crutch</em> upon which a lot of users will latch instead of
learning to model transfers using balanced transactions. I have yet to
come across a sufficiently convincing case for them<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup>.</p>
<p>This provides the property that any subsets of transactions will sum up
to zero. This is a nice property to have, it means we can generate
balance sheets at any point in time. Even when we eventually <a href="../28_settlement_dates_in_beancount/"><span
class="underline">support settlement dates or per-posting
dates</span></a>, we will split up
transactions in a way that does not break this invariant.</p>
<h3 id="accounts-have-types">Accounts Have Types<a class="headerlink" href="#accounts-have-types" title="Permanent link"></a></h3>
<p>Beancount accounts should be constrained to be of one of five types:
Assets, Liabilities, Income, Expenses and Equity. The rationale behind
this is to realize that all matters of counting can be characterized by
being either permanent (Assets, Liabilities) or transitory (Income,
Expenses), and that the great majority of accounts have a usual balance
sign: positive (Assets, Expenses) or negative (Liabilities, Income).
Given a quantity to accumulate, we can always select one of these four
types of labels for it.</p>
<p>Enforcing this makes it possible to implement reports of accumulates
values for permanent accounts (balance sheet) and reports of changes of
periods of time (income statement). Although it is technically possible
to explicitly book postings against Equity accounts the usual purpose of
items in that category is to account for past changes on the balance
sheet (net/retained income or opening balances).</p>
<p>These concepts of time and sign generalize beyond that of traditional
accounting. Not having them raises difficult and unnecessary questions
about how to handle calculating these types of reports. We simply
require that you label your accounts into this model. I’ll admit that
this requires a bit of practice and forethought, but the end result is a
structure that easily allows us to build commonly expected outputs.</p>
<h3 id="account-lifetimes-open-directives">Account Lifetimes &amp; Open Directives<a class="headerlink" href="#account-lifetimes-open-directives" title="Permanent link"></a></h3>
<p>Accounts have lifetimes; an account opens at a particular date and
optionally closes at another. This is directed by the Open and Close
directives.</p>
<p>All accounts are required to have a corresponding Open directive in the
stream. By default, this is enforced by spitting out an error when
posting to an account whose Open directive hasn’t been seen in the
stream. You can automate the generation of these directives by using the
“auto_accounts” plugin, but in any case, the stream of entries will
always contain the Open directives. This is an assumption that one
should be able to rely upon when writing scripts.</p>
<p>(Eventually a similar constraint will be applied for Commodity
directives so that the stream always include one before it is used; and
they should be auto-generated as well. This is not the case right now
[June 2015].)</p>
<h3 id="supports-dates-only-and-no-time">Supports Dates Only (and No Time)<a class="headerlink" href="#supports-dates-only-and-no-time" title="Permanent link"></a></h3>
<p>Beancount does not represent time, only dates. The minimal time interval
is one day. This is for simplicity’s sake. The situations where time
would be necessary to disambiguate account balances exist, but in
practice they are rare enough that their presence does not justify the
added complexity of handling time values and providing syntax to deal
with it.</p>
<p>If you have a use case whereby times are required, you may use metadata
to add it in, or more likely, you should probably write custom software
for it. This is outside the scope of Beancount by choice.</p>
<h3 id="metadata-is-for-user-data">Metadata is for User Data<a class="headerlink" href="#metadata-is-for-user-data" title="Permanent link"></a></h3>
<p>By default, Beancount will not make assumptions about metadata fields
and values. Metadata is reserved for private usage by the user and for
plugins. The Beancount core does not read metadata and change its
processing based on it. However, plugins may define special metadata
values that affect what they produce.</p>
<p>That being said, there are a few special metadata fields <em>produced</em> by
the Beancount processing:</p>
<ul>
<li>
<p>filename: A string, the name of the file the transaction was read from (or the plugin that created it)</p>
</li>
<li>
<p>lineno: An integer, the line number from the file where the transaction was read from.</p>
</li>
<li>
<p><strong>tolerances</strong>: A dict of currency to Decimal, the tolerance values used in balancing the transaction.</p>
</li>
<li>
<p><strong>residual</strong> (on Postings): A boolean, true if the posting has been added to automatically absorb rounding error.</p>
</li>
</ul>
<p>There may be a few more produced in the future but in any case, the core
should not read any metadata and affect its behavior as a consequence.
(I should probably created a central registry or location where all the
special values can be found in one place.)</p>
<h2 id="overview-of-the-codebase">Overview of the Codebase<a class="headerlink" href="#overview-of-the-codebase" title="Permanent link"></a></h2>
<p>All source code lives under a “<a href="https://bitbucket.org/blais/beancount/src/tip/src/python/beancount/"><span
class="underline">beancount</span></a>”
Python package. It consists of several packages with well-defined roles,
the dependencies between which are enforced strictly.</p>
<p><img src="media/8a94847808878214d3557076d587ecc648809812.png" style="width:5.80556in;height:4.94444in" /></p>
<p><em>Beancount source code packages and approximate dependencies between
them.</em></p>
<p>At the bottom, we have a <a href="https://bitbucket.org/blais/beancount/src/tip/src/python/beancount/core"><span
class="underline">beancount.core</span></a>
package which contains the data structures used to represent
transactions and other directives in memory. This contains code for
accounts, amounts, lots, positions, and inventories. It also contains
commonly used routines for processing streams of directives.</p>
<p>One level up, the <a href="https://bitbucket.org/blais/beancount/src/tip/src/python/beancount/parser"><span
class="underline">beancount.parser</span></a>
package contains code to parse the Beancount language and a printer that
can produce the corresponding text given a stream of directives. It
should be possible to convert between text and data structure and
round-trip this process without loss.</p>
<p>At the root of the main package is a <a href="https://bitbucket.org/blais/beancount/src/tip/src/python/beancount/loader.py"><span
class="underline">beancount.loader</span></a>
module that coordinates everything that has to be done to load a file in
memory. This is the main entry point for anyone writing a script for
Beancount, it always starts with loading a stream of entries. This calls
the parser, runs some processing code, imports the plugins and runs them
in order to produce the final stream of directives which is used to
produce reports.</p>
<p>The <a href="https://bitbucket.org/blais/beancount/src/tip/src/python/beancount/plugins"><span
class="underline">beancount.plugins</span></a>
package contains implementations of various plugins. Each of these
plugin modules are independent from each other. Consult the docstrings
in the source code to figure out what each of these does. Some of these
are prototypes of ideas.</p>
<p>There is a <a href="https://bitbucket.org/blais/beancount/src/tip/src/python/beancount/"><span
class="underline">beancount.ops</span></a>
package which contains some high-level processing code and some of the
default code that always runs by default that is implemented as plugins
as well (like padding using the Pad directive). This package needs to be
shuffled a bit in order to clarify its role.</p>
<p>On top of this, reporting code calls modules from those packages. There
are four packages which contain reporting code, corresponding to the
Beancount reporting tools:</p>
<ul>
<li>
<p><a href="https://bitbucket.org/blais/beancount/src/tip/src/python/beancount/reports/"><span
    class="underline">beancount.reports</span></a>:
    This package contains code specialized to produce different kinds of
    outputs (invoked by bean-report). In general I’d like to avoid
    defining custom routines to produce desired outputs and use the SQL
    query tool to express grouping &amp; aggregation instead, but I think
    there will always be a need for at least some of these. The reports
    are defined in a class hierarchy with a common interface and you
    should be able to extend them. Each report supports some subset of a
    number of output formats.</p>
</li>
<li>
<p><a href="https://bitbucket.org/blais/beancount/src/tip/src/python/beancount/query/"><span
    class="underline">beancount.query</span></a>:
    This package contains the implementation of a query language and
    interactive shell (invoked by bean-query) that allows you to group
    and aggregate positions using a SQL-like DSL. This essentially
    implements processing over an in-memory table of Posting objects,
    with functions defined over Amount, Position and Inventory objects.</p>
</li>
<li>
<p><a href="https://bitbucket.org/blais/beancount/src/tip/src/python/beancount/"><span
    class="underline">beancount.web</span></a>:
    This package contains all the source code for the default web
    interface (invoked by bean-web). This is a simple <a href="http://bottlepy.org/"><span
    class="underline">Bottle</span></a> application
    that serves many of the reports from beancount.report to HTML
    format, running on your machine locally. The web interface provides
    simple views and access to your data. (It stands to be improved
    greatly, it’s in no way perfect.)</p>
</li>
<li>
<p><a href="https://bitbucket.org/blais/beancount/src/tip/src/python/beancount/projects/"><span
    class="underline">beancount.projects</span></a>:
    This package contains various custom scripts for particular
    applications that I’ve wanted to share and distribute. Wherever
    possible, I aim to fold these into reports. There are no scripts to
    invoke these; you should use “python3 -m
    beancount.projects.&lt;name&gt;” to run them.</p>
</li>
</ul>
<p>There is a <a href="https://bitbucket.org/blais/beancount/src/tip/src/python/beancount/scripts/"><span
class="underline">beancount.scripts</span></a>
package that contains the “main” programs for all the scripts under the
<a href="https://bitbucket.org/blais/beancount/src/tip/bin"><span class="underline">bin
directory</span></a>.
Those scripts are simple launchers that import the corresponding file
under beancount.scripts. This allows us to keep all the source code
under a single directory and that makes it easier to run linters and
other code health checkers on the code—it’s all in one place.</p>
<p>Finally, there is a <a href="https://bitbucket.org/blais/beancount/src/tip/src/python/beancount/utils"><span
class="underline">beancount.utils</span></a>
package which is there to contain generic reusable random bits of
utility code. And there is a relatively unimportant <a href="https://bitbucket.org/blais/beancount/src/tip/src/python/beancount/docs/"><span
class="underline">beancount.docs</span></a>
package that contains code used by the author just to produce and
maintain this documentation (code that connects to Google Drive).</p>
<p>Enforcing the dependency relationships between those packages is done by
a <a href="https://bitbucket.org/blais/beancount/src/tip/tools/dependency_constraints.py?at=default&amp;fileviewer=file-view-default"><span class="underline">custom
script</span></a>.</p>
<h2 id="core-data-structures">Core Data Structures<a class="headerlink" href="#core-data-structures" title="Permanent link"></a></h2>
<p>This section describes the basic data structures that are used as
building blocks to represent directives. Where possible I will describe
the data structure in conceptual terms.</p>
<p><em>(Note for Ledger users</em>: This section introduces some terminology for
Beancount; look <a href="http://ledger-cli.org/3.0/doc/ledger3.html#Ledger-for-Developers"><span
class="underline">here</span></a>
if you’re interested to contrast it with concepts and terminology found
in Ledger.)</p>
<h3 id="number">Number<a class="headerlink" href="#number" title="Permanent link"></a></h3>
<p><strong>Numbers</strong> are represented using <a href="https://en.wikipedia.org/wiki/Decimal_data_type"><span
class="underline">decimal</span></a>
objects, which are perfectly suited for this. The great majority of
numbers entered in accounting systems are naturally decimal numbers and
binary representations involve representational errors which cause many
problems for display and in precision. Rational numbers avoid this
problem, but they do not carry the limited amount of precision that the
user intended in the input. We must deal with <a href="../08_precision_tolerances/"><span
class="underline">tolerances</span></a>
explicitly.</p>
<p>Therefore, all numbers should use Python’s “decimal.Decimal” objects.
Conveniently, Python v3.x supports a C implementation of decimal types
natively (in its standard library; this used to be an external
“cdecimal” package to install but it has been integrated in the C/Python
interpreter).</p>
<p>The default constructor for decimal objects does not support some of the
input syntax we want to allow, such as commas in the integer part of
numbers (e.g., “278<strong>,</strong>401.35 USD”) or initialization from an empty
string. These are important cases to handle. So I provide a special
constructor to accommodate these inputs: beancount.core.number.D(). This
is the only method that should be used to create decimal objects:</p>
<pre><code>from beancount.core.number import D
…
number = D("2,402.21")
</code></pre>
<p>I like to import the “D” symbol by itself (and not use number.D). All
the number-related code is located under <a href="https://bitbucket.org/blais/beancount/src/tip/src/python/beancount/core/number.py"><span
class="underline">beancount.core.number</span></a>.</p>
<p>Some number constants have been defined as well: ZERO, ONE, and HALF.
Use those instead of explicitly constructed numbers (such as D("1")) as
it makes it easier to grep for such initializations.</p>
<h3 id="commodity">Commodity<a class="headerlink" href="#commodity" title="Permanent link"></a></h3>
<p>A <strong>commodity</strong>, or <strong>currency</strong> (I use both names interchangeably in
the code and documentation) is a string that represents a kind of
“thing” that can be stored in accounts. In the implementation, it is
represented as a Python str object (there is no module with currency
manipulation code). These strings may only contain capital letters and
numbers and some special characters (see the lexer code).</p>
<p>Beancount does not predefine any currency names or categories—all
currencies are created equal. Really. It genuinely does not know
anything special about dollars or euros or yen or anything else. The
only place in the source code where there is a reference to those is in
the tests. There is no support for syntax using “$” or other currency
symbols; I understand that some users may want this syntax, but in the
name of keeping the parser very simple and consistent I choose not to
provide that option.</p>
<p>Moreover, Beancount does not make a distinction between commodities
which represent "money" and others that do not (such as shares, hours,
etc.). These are treated the same throughout the system. It also does
not have the concept of a "home" currency<sup id="fnref:2"><a class="footnote-ref" href="#fn:2">2</a></sup>; it's a genuinely
multi-currency system.</p>
<p>Currencies need <em>not</em> be defined explicitly in the input file format;
you can just start using them in the file and they will be recognized as
such by their unique syntax (the lexer recognizes and emits currency
tokens). However, you <em>may</em> declare some using a Commodity directive.
This is only provided so that a per-commodity entity exists upon which
the user can attach some metadata, and some report and plugins are able
to find and use that metadata.</p>
<h3 id="account">Account<a class="headerlink" href="#account" title="Permanent link"></a></h3>
<p>An account is basically just the name of a bucket associated with a
posting and is represented as a simple string (a Python str object).
Accounts are detected and tokenized by the lexer and have names with at
least two words separated by a colon (":").</p>
<p>Accounts don’t have a corresponding object type; we just refer to them
by their unique name string (like filenames in Python). When per-account
attributes are needed, we can extract the Open directives from the
stream of entries and find the one corresponding to the particular
account we’re looking for.</p>
<p>Similar to Python’s os.path module, there are some routines to
manipulate account names in <a href="https://bitbucket.org/blais/beancount/src/default/beancount/core/account.py"><span
class="underline">beancount.core.account</span></a>
and the functions are named similarly to those of the <a href="https://docs.python.org/3.3/library/os.path.html"><span
class="underline">os.path</span></a>
module.</p>
<p>The first component of an account’s name is limited to one of five
types:</p>
<ul>
<li>
<p>Assets</p>
</li>
<li>
<p>Liabilities</p>
</li>
<li>
<p>Equity</p>
</li>
<li>
<p>Income</p>
</li>
<li>
<p>Expenses</p>
</li>
</ul>
<p>The names of the account types as read in the input syntax may be
customized with some "option" directives, so that you can change those
names to another language, or even just rename "Income" to "Revenue" if
you prefer that. The <a href="https://bitbucket.org/blais/beancount/src/tip/src/python/beancount/core/account_types.py"><span
class="underline">beancount.core.account_types</span></a>
module contains some helpers to deal with these.</p>
<p>Note that the set of account names forms an implicit hierarchy. For
example, the names:</p>
<pre><code>Assets:US:TDBank:Checking
Assets:US:TDBank:Savings
</code></pre>
<p>implicitly defines a tree of nodes with parent nodes "Assets", "US",
"TDBank" with two leaf nodes "Checking" and "Savings". This implicit
tree is never realized during processing, but there is a Python module
that allows one to do this easily (see <a href="https://bitbucket.org/blais/beancount/src/tip/src/python/beancount/core/realization.py"><span
class="underline">beancount.core.realization</span></a>)
and create linearized renderings of the tree.</p>
<h3 id="flag">Flag<a class="headerlink" href="#flag" title="Permanent link"></a></h3>
<h3 id="a-flag-is-a-single-character-string-that-may-be-associated-with-transactions-and-postings-to-indicate-whether-they-are-assumed-to-be-correct-reconciled-or-flagged-as-suspicious-the-typical-value-used-on-transaction-instances-is-the-character-42-on-postings-it-is-usually-left-absent-and-set-to-a-none">A “flag” is a single-character string that may be associated with Transactions and Postings to indicate whether they are assumed to be correct ("reconciled") or flagged as suspicious. The typical value used on transaction instances is the character “*”. On Postings, it is usually left absent (and set to a None).<a class="headerlink" href="#a-flag-is-a-single-character-string-that-may-be-associated-with-transactions-and-postings-to-indicate-whether-they-are-assumed-to-be-correct-reconciled-or-flagged-as-suspicious-the-typical-value-used-on-transaction-instances-is-the-character-42-on-postings-it-is-usually-left-absent-and-set-to-a-none" title="Permanent link"></a></h3>
<h3 id="amount">Amount<a class="headerlink" href="#amount" title="Permanent link"></a></h3>
<p>An <strong>Amount</strong> is the combination of a number and an associated currency,
conceptually:</p>
<pre><code>Amount = (Number, Currency)
</code></pre>
<p>Amount instances are used to represent a quantity of a particular
currency (the “units”) and the price on a posting.</p>
<p>A class is defined in <a href="https://bitbucket.org/blais/beancount/src/tip/src/python/beancount/core/amount.py"><span
class="underline">beancount.core.amount</span></a>
as a simple tuple-like object. Functions exist to perform simple math
operations directly on instances of Amount. You can also create Amount
instance using amount.from_string(), for example:</p>
<pre><code>value = amount.from_string("201.32 USD")
</code></pre>
<h3 id="cost">Cost<a class="headerlink" href="#cost" title="Permanent link"></a></h3>
<p>A Cost object represents the cost basis for a particular lot of a
commodity. Conceptually, it is</p>
<pre><code>Cost = (Number, Currency, Date, Label)
</code></pre>
<p>The number and currency is that of the cost itself, not of the
commodity. For example, if you bought 40 shares of AAPL stock at 56.78
USD, the <em>Number</em> is a “56.78” decimal and the <em>Currency</em> is “USD.” For
example:</p>
<pre><code>Cost(Decimal("56.78"), "USD", date(2012, 3, 5), "lot15")
</code></pre>
<p>The <em>Date</em> is the acquisition date of the corresponding lot (a
datetime.date object). This is automatically attached to the Cost object
when a posting augments an inventory—the Transaction’s date is
automatically attached to the Cost object—or if the input syntax
provides an explicit date override.</p>
<p>The <em>Label</em> can be any string. It is provided as a convenience for a
user to refer to a particular lot or disambiguate similar lots.</p>
<p>On a Cost object, the number, currency and date attributes are always
set. If the label is unset, it has a value of “None.”</p>
<h4 id="costspec">CostSpec<a class="headerlink" href="#costspec" title="Permanent link"></a></h4>
<p>In the input syntax, we allow users to provide as little information as
necessary in order to disambiguate between the lots contained in the
inventory prior to posting. The data provided filters the set of
matching lots to an unambiguous choice, or to a subset from which an
automated booking algorithm will apply (e.g., “FIFO”).</p>
<p>In addition, we allow the user to provide either the per-unit cost
and/or the total-cost. This convenience is useful to let Beancount
automatically compute the per-unit cost from a total of proceeds.</p>
<pre><code>CostSpec = (Number-per-unit, Number-total, Currency, Date, Label, Merge)
</code></pre>
<p>Since any of the input elements may be omitted, any of the attributes of
a CostSpec may be left to None. If a number is missing and necessary to
be filled in, the special value “MISSING” will be set on it.</p>
<p>The <em>Merge</em> attribute it used to record a user request to merge all the
input lots before applying the transaction and to merge them after. This
is the method used for all transactions posted to an account with the
“AVERAGE” booking method.</p>
<h3 id="position">Position<a class="headerlink" href="#position" title="Permanent link"></a></h3>
<p>A position represents some units of a particular commodity held at cost.
It consists simply in</p>
<pre><code>Position = (Units, Cost)
</code></pre>
<p><em>Units</em> is an instance of <em>Amount</em>, and <em>Cost</em> is an instance of <em>Cost</em>,
or a null value if the commodity is not held at cost. Inventories
contain lists of <em>Position</em> instances. See its definition in <a href="https://bitbucket.org/blais/beancount/src/tip/src/python/beancount/core/position.py"><span
class="underline">beancount.core.position</span></a><s>.</s></p>
<h3 id="posting">Posting<a class="headerlink" href="#posting" title="Permanent link"></a></h3>
<p>Each Transaction directive is composed of multiple Postings (I often
informally refer to these in the code and on the mailing-list as the
“legs” of a transaction). Each of these postings is associated with an
account, a position and an optional price and flag:</p>
<pre><code>Posting = (Account, Units, Cost-or-CostSpec, Price, Flag, Metadata)
</code></pre>
<p>As you can see, a <em>Posting</em> embeds its <em>Position</em> instance<sup id="fnref:3"><a class="footnote-ref" href="#fn:3">3</a></sup>. The
<em>Units</em> is an <em>Amount</em>, and the ‘cost’ attribute refers to either a
<em>Cost</em> or a <em>CostSpec</em> instance (the parser outputs <em>Posting</em> instances
with an <em>CostSpec</em> attribute which is resolved to a <em>Cost</em> instance by
the booking process; see <a href="../11_how_inventories_work/"><span class="underline">How Inventories
Work</span></a> for details).</p>
<p>The <em>Price</em> is an instance of <em>Amount</em> or a null value. It is used to
declare a currency conversion for balancing the transaction, or the
current price of a position held at cost. It is the Amount that appears
next to a “@” in the input.</p>
<p>Flags on postings are relatively rare; users will normally find it
sufficient to flag an entire transaction instead of a specific posting.
The flag is usually left to None; if set, it is a single-character
string.</p>
<h3 id="the-posting-type-is-defined-in-beancountcoredata-along-with-all-the-directive-types">The Posting type is defined in <a href="https://bitbucket.org/blais/beancount/src/tip/src/python/beancount/core/data.py"><span class="underline">beancount.core.data</span></a>, along with all the directive types.<a class="headerlink" href="#the-posting-type-is-defined-in-beancountcoredata-along-with-all-the-directive-types" title="Permanent link"></a></h3>
<h3 id="inventory">Inventory<a class="headerlink" href="#inventory" title="Permanent link"></a></h3>
<p>An Inventory is a container for an account’s balance in various lots of
commodities. It is essentially a list of <em>Position</em> instances with
suitable operations defined on it. Conceptually you may think of it as a
mapping with unique keys:</p>
<pre><code>Inventory = [Position1, Position2, Position3, … , PositionN]
</code></pre>
<p>Generally, the combination of a position’s (<em>Units.Currency, Cost)</em> is
kept unique in the list, like the key of a mapping. Positions for equal
values of currency and cost are merged together by summing up their
<em>Units.Number</em> and keeping a single position for it. And simple
positions are mixed in the list with positions held at cost.</p>
<p>The <em>Inventory</em> is one of the most important and oft-used object in
Beancount’s implementation, because it is used to sum the balance of one
or more accounts over time. It is also the place where the inventory
reduction algorithms get applied to, and traces of that mechanism can be
found there. The “<a href="../11_how_inventories_work/"><span class="underline">How Inventories
Work</span></a>” document provides the full
detail of that process.</p>
<p>For testing, you can create initialized instances of Inventory using
inventory.from_string(). All the inventory code is written in <a href="https://bitbucket.org/blais/beancount/src/tip/src/python/beancount/core/inventory.py"><span
class="underline">beancount.core.inventory</span></a>.</p>
<h3 id="about-tuples-mutability">About Tuples &amp; Mutability<a class="headerlink" href="#about-tuples-mutability" title="Permanent link"></a></h3>
<p>Despite the program being written in a language which does not make
mutability “difficult by default”, I designed the software to avoid
mutability in most places. Python provides a “collections.namedtuple”
factory that makes up new record types whose attributes cannot be
overridden. Well… this is only partially true: mutable attributes of
immutable tuples can be modified. Python does not provide very strong
mechanisms to enforce this property.</p>
<p>Regardless, functional programming is not so much an attribute of the
language used to implement our programs than of the guarantees we build
into its structure. A language that supports strong guarantees helps to
enforce this. But if, even by just using a set of conventions, we manage
to <em>mostly</em> avoid mutability, we have a <em>mostly</em> functional program that
avoids <em>most</em> of the pitfalls that occur from unpredictable mutations
and our code is that much easier to maintain. Programs with no
particular regard for where mutation occurs are most difficult to
maintain. By avoiding most of the mutation in a functional approach, we
avoid most of those problems.</p>
<ul>
<li>
<p>Most of the data structures used in Beancount are <a href="https://docs.python.org/3/library/collections.html#collections.namedtuple"><span
    class="underline">namedtuples</span></a>,
    which make the modification of their attributes inconvenient on
    purpose.</p>
</li>
<li>
<p>Most of the code will attempt to avoid mutation, except for local
    state (within a function) or in a narrow scope that we can easily
    wrap our head around. Where mutation is possible, by convention I
    try to avoid it by default. When we do mutation, I try to document
    the effects.</p>
</li>
<li>
<p>I avoid the creation of classes which mutate their internal state,
    except for a few cases (e.g. the web application). I prefer
    functions to objects and where I define classes I mostly avoid
    inheritance.</p>
</li>
</ul>
<p>These properties are especially true for all the small objects: Amount,
Lot, Position, Posting objects, and all the directives types from <a href="https://bitbucket.org/blais/beancount/src/tip/src/python/beancount/core/data.py"><span
class="underline">beancount.core.data</span></a>.</p>
<p>On the other hand, the Inventory object is nearly always used as an
accumulator and <em>does</em> allow the modification of its internal state (it
would require a special, persistent data structure to avoid this). You
have to be careful how you share access to Inventory objects… and modify
them, if you ever do.</p>
<p>Finally, the loader produces lists of directives which are all simple
namedtuple objects. These lists form the main application state. I’ve
avoided placing these inside some special container and instead pass
them around explicitly, on purpose. Instead of having some sort of big
“application” object, I’ve trimmed down all the fat and all your state
is represented in two things: A dated and sorted list of directives
which can be the subject of stream processing and a list of constant
read-only option values. I think this is simpler.</p>
<p><em>I credit my ability to make wide-ranging changes to a mid-size Python
codebase to the adoption of these principles. I would love to have
<strong>types</strong> in order to safeguard against another class of potential
errors, and I plan to experiment with <a href="https://www.python.org/dev/peps/pep-0484/"><span class="underline">Python
3.5’s upcoming typing
module</span></a>.</em></p>
<h3 id="summary">Summary<a class="headerlink" href="#summary" title="Permanent link"></a></h3>
<p>The following diagram explains how these objects relate to each other,
starting from a Posting.</p>
<p><img src="media/93cd070d4d5efd741b33a3e91d6b3e8f86e58be6.png" style="width:4.36111in;height:6.11111in" /></p>
<p>For example, to access the number of units of a postings you could use</p>
<pre><code>posting.units.number
</code></pre>
<p>For the cost currency:</p>
<pre><code>posting.cost.currency
</code></pre>
<p>You can print out the tuples in Python to figure out their structure.</p>
<h4 id="previous-design">Previous Design<a class="headerlink" href="#previous-design" title="Permanent link"></a></h4>
<p>For the sake of preservation, if you go back in time in the repository,
the structure of postings was deeper and more complex. The new design
reflects a flatter and simpler version of it. Here is what the old
design used to look like:</p>
<p><img src="media/a36336143a27c30f063d6ef8edc147ff87d0beb2.png" style="width:6.69444in;height:4.19444in" /></p>
<h2 id="directives">Directives<a class="headerlink" href="#directives" title="Permanent link"></a></h2>
<p>The main production from loading a Beancount input file is a list of
<strong>directives</strong>. I also call these <strong>entries</strong> interchangeably in the
codebase and in the documents. There are directives of various types:</p>
<ul>
<li>
<p>Transaction</p>
</li>
<li>
<p>Balance &amp; Pad</p>
</li>
<li>
<p>Open &amp; Close</p>
</li>
<li>
<p>Commodity</p>
</li>
<li>
<p>Note</p>
</li>
<li>
<p>Event</p>
</li>
<li>
<p>Price</p>
</li>
<li>
<p>Document</p>
</li>
</ul>
<p>In a typical Beancount input file, the great majority of entries will be
Transactions and some Balance assertions. There will also be Open &amp;
perhaps some Close entries. Everything else is optional.</p>
<p>Since these combined with a map of option values form the entire
application state, you should be able to feed those entries to functions
that will produce reports. The system is built around this idea of
processing a stream of directives to extract all contents and produce
reports, which are essentially different flavors of filtering and
aggregations of values attached to this stream of directives.</p>
<h3 id="common-properties">Common Properties<a class="headerlink" href="#common-properties" title="Permanent link"></a></h3>
<p>Some properties are in common to <em>all</em> the directives:</p>
<ul>
<li><strong>Date.</strong> A datetime.date object. This is useful and consistent. For
    a Transaction, that’s the date at which it occurs. For an Open or
    Close directive, that’s the date at which the account was opened or
    closed. For a Pad directive, that’s the date at which to insert a
    transaction. For a Note or Document, it is the date at which to
    insert the note in the stream of postings of that account. For an
    Event, it is the date at which it occurs. For a Commodity directive
    which essentially provides a per-commodity hanging point for
    commodity-related metadata, the date isn’t as meaningful; I choose
    to date those on the day the commodity was created.</li>
</ul>
<!-- -->

<ul>
<li><strong>Meta</strong>. All the directives have metadata attribute (a Python dict
    object). The purpose of metadata is to allow the user to hang any
    kind of ancillary data they want and then use this in scripts or
    queries. Posting instances also have a metadata attribute.</li>
</ul>
<h3 id="transactions">Transactions<a class="headerlink" href="#transactions" title="Permanent link"></a></h3>
<p>The Transaction directive is the subject of Beancount and is by far the
most common directive found in input files and is worth of special
attention. The function of a bookkeeping system is to organize the
Postings attached to Transactions in various ways. All the other types
of entries occupy supporting roles in our system.</p>
<p>A Transaction has the following additional fields.</p>
<h4 id="flag_1">Flag<a class="headerlink" href="#flag_1" title="Permanent link"></a></h4>
<p>The single-character flag is usually there to replace the “txn” keyword
(Transaction is the only directive which allows being entered without
entering its keyword). I’ve been considering changing the syntax
definition somewhat to allow not entering the flag nor the keyword,
because I’d like to eventually support that. Right now, either the flag
or keyword is required. The flag attribute may be set to None.</p>
<h4 id="payee-narration">Payee &amp; Narration<a class="headerlink" href="#payee-narration" title="Permanent link"></a></h4>
<p>The narration field is a user-provided description of the transaction,
such as "Dinner with Mary-Ann." You can put any information in this
string. It shows up in the journal report. Oftentimes it is used to
enrich the transaction with context that cannot be imported
automatically, such as "transfer from savings account to pay for car
repairs."<br />
The payee name is optional, and exists to describe the entity with which
the transaction is conducted, such as "Whole Foods Market" or "Shell."<br />
Note that I want to be able to produce reports for all transactions
associated with a particular payee, so it would be nice to enter
consistent payee names. The problem with this is that the effort to do
this right is sometimes too great. Either better tools or looser
matching over names is required in order to make this work.<br />
The input syntax also allows only a single string to be provided. By
default this becomes the narration, but I’ve found that in practice it
can be useful to have just the payee. It’s just a matter of convenience.
At the moment, if you want to enter just the payee string you need to
append an empty narration string. This should be revisited at some
point.</p>
<h4 id="tags">Tags<a class="headerlink" href="#tags" title="Permanent link"></a></h4>
<p>Tags are sets of strings that can be used to group sets of transactions
(or set to None if there are no tags). A view of this subset of
transactions can then be generated, including all the usual reports
(balance sheet, income statement, journals, etc.). You can tag
transactions for a variety of purposes; here are some examples:</p>
<ul>
<li>All transactions during a particular travel might be tagged to later
    summarize your trip expenses. Those transactions will usually occur
    around the same date and therefore there is convenient syntax used
    to automatically tag many transactions that are declared together in
    a file.</li>
</ul>
<!-- -->

<ul>
<li>
<p>Transactions related to a particular project to be accomplished. I
    took some classes in an online program once, and tagged all related
    expenses to it. I use this to track all my immigration-related
    expenses for a particular stage (e.g. green card).</p>
</li>
<li>
<p>Declaring a group of expenses to be paid back by an employer (or
    your own company) later on.</p>
</li>
<li>
<p>Expenses related to moving between locations.</p>
</li>
</ul>
<p>Typical tag names that I use for tags look like "#trip-israel-2012",
"#conference-siggraph", and "#course-cfa".</p>
<p>In general, tags are useful where adding a sub-accounts won't do. This
is often the case where a group of related expenses are of differing
types, and so they would not belong to a single account.</p>
<p>Given the right support from the query tools, they could eventually be
subsumed by metadata—I have been considering converting tags into
metadata keys with a boolean value of True, in order to remove
unnecessary complexity.</p>
<h4 id="links">Links<a class="headerlink" href="#links" title="Permanent link"></a></h4>
<p>Links are a unique sets of strings or None, and in practice will be
usually empty for most transactions. They differ from tags only in
purpose.</p>
<p>Links are there to chain together a list of related transactions and
there are tools used to list, navigate and balance a subset of
transactions linked together. They are a way for a transaction to refer
to other transactions. They are not meant to be used for summarizing.</p>
<p>Examples include: transaction-ids from trading accounts (these often
provide an id to a "related" or "other" transaction); account entries
associated with related corrections, for example a reversed fee
following a phone call could be linked to the original invalid fee from
several weeks before; the purchase and sale of a home, and related
acquisition expenses.</p>
<p>In contrast to tags, their strings are most often unique numbers
produced by the importers. No views are produced for links; only a
journal of a particular links transactions can be produced and a
rendered transaction should be accompanied by an actual "link" icon you
can click on to view all the other related transactions.</p>
<h4 id="postings">Postings<a class="headerlink" href="#postings" title="Permanent link"></a></h4>
<p>A list of Postings are attached to the Transaction object. Technically
this list object is mutable but in practice we try not to modify it. A
Posting can ever only be part of a single Transaction.</p>
<p>Sometimes different postings of the same transaction will settle at
different dates in their respective accounts, so eventually we may allow
a posting to have its own date to override the transaction's date, to be
used as documentation; in the simplest version, we enforce all
transactions to occur punctually, which is simple to understand and was
not found to be a significant problem in practice. Eventually we might
implement this by implicitly converting Transactions with multiple dates
into multiple Transactions and using some sort of transfer account to
hold the pending balance in-between dates. See the <a href="../28_settlement_dates_in_beancount/"><span
class="underline">associated
proposal</span></a> for details.</p>
<h4 id="balancing-postings">Balancing Postings<a class="headerlink" href="#balancing-postings" title="Permanent link"></a></h4>
<p>The fundamental principle of double-entry book-keeping is enforced in
each of the Transaction entries: the sum of all postings must be zero.
This section describes the specific way in which we do this, and is the
<strong>key piece of logic</strong> that allow the entire system to balance nicely.
This is also one of the few places in this system where calculations go
beyond simple filtering and aggregation.</p>
<p>As we saw earlier, postings are associated with</p>
<ul>
<li>
<p>A position, which is a number of units of a lot (which itself may or
    may not have a cost)</p>
</li>
<li>
<p>An optional conversion price</p>
</li>
</ul>
<p>Given this, how do we balance a transaction?</p>
<p>Some terminology is in order: for this example posting:</p>
<pre><code>Assets:Investment:HOOL    -50 HOOL {700 USD} @ 920 USD
</code></pre>
<p><strong>Units.</strong> The number of units is the number of position, or “50”.</p>
<p><strong>Currency.</strong> The commodity of the lot, that is, “HOOL”.</p>
<p><strong>Cost.</strong> The cost of this position is the number of units times the
per-unit cost in the cost currency, that is 50 x 700 = 35000 USD.</p>
<p><strong>(Total) Price.</strong> The price of a unit is the attached price amount, 920
USD. The total price of a position is its number of units times the
conversion price, in this example 50 x 920 = 46000 USD.</p>
<p><strong>Weight.</strong> The amount used to balance each posting in the transaction:</p>
<ol>
<li>
<p>If the posting has an associated cost, we calculate the cost of the
    position (regardless of whether a price is present or not);</p>
</li>
<li>
<p>If the posting has no associated cost but has a conversion price, we
    convert the position into its total price;</p>
</li>
<li>
<p>Finally, if the posting has no associated cost nor conversion price,
    the number of units of the lot are used directly.</p>
</li>
</ol>
<p>Balancing is really simple: each of the Posting's positions are first
converted into their weight. These amounts are then grouped together by
currency, and the final sums for each currency is asserted to be close
to zero, that is, within a small amount of tolerance (as <a href="../08_precision_tolerances/"><span
class="underline">inferred by a combination of by the numbers in the
input and the options</span></a>).</p>
<p>The following example is one of case (2), with a price conversion and a
regular leg with neither a cost nor a price (case 3):</p>
<pre><code>2013-07-22 * "Wired money to foreign account"
  Assets:Investment:HOOL     -35350 CAD @ 1.01 USD        ;; -35000 USD (2)
  Assets:Investment:Cash      35000 USD                   ;;  35000 USD (3)
                                                          ;;------------------
                                                          ;;      0 USD
</code></pre>
<p>In the next example, the posting for the first leg has a cost, the
second posting has neither:</p>
<pre><code>2013-07-22 * "Bought some investment"
  Assets:Investment:HOOL     50 HOOL {700 USD}            ;;  35000 USD (1)
  Assets:Investment:Cash    -35000 USD                    ;; -35000 USD (3)
                                                          ;;------------------
                                                          ;;      0 USD
</code></pre>
<p>Here's a more complex example with both a price and a cost; the price
here is ignored for the purpose of balance and is used only to enter a
data-point in the internal price database:</p>
<pre><code>2013-07-22 * "Sold some investment"
  Assets:Investment:HOOL    -50 HOOL {700 USD} @ 920 USD  ;; -35000 USD (1)
  Assets:Investment:Cash     46000 USD                    ;;  46000 USD (3)
  Income:CapitalGains       -11000 USD                    ;; -11000 USD (3)
                                                          ;;------------------
                                                          ;;      0 USD
</code></pre>
<p>Finally, here's an example with multiple commodities:</p>
<pre><code>     2013-07-05 * "COMPANY INC PAYROLL"
       Assets:US:TD:Checking                            4585.38 USD
       Income:US:Company:GroupTermLife                   -25.38 USD
       Income:US:Company:Salary                        -5000.00 USD
       Assets:US:Vanguard:Cash                           540.00 USD
       Assets:US:Federal:IRAContrib                     -540.00 IRAUSD
       Expenses:Taxes:US:Federal:IRAContrib              540.00 IRAUSD
       Assets:US:Company:Vacation                          4.62 VACHR
       Income:US:Company:Vacation                         -4.62 VACHR
</code></pre>
<p>Here there are three groups of weights to balance:</p>
<ul>
<li>
<p>USD: (4485.38) + (-25.38) + (-5000) + (540) ~= 0 USD</p>
</li>
<li>
<p>IRAUSD: (540.00) + (-540.00) ~= 0 IRAUSD</p>
</li>
<li>
<p>VACHR: (4.62) + (-4.62) ~= 0 VACHR</p>
</li>
</ul>
<h5 id="elision-of-amounts">Elision of Amounts<a class="headerlink" href="#elision-of-amounts" title="Permanent link"></a></h5>
<p>Transactions allow for at most one posting to be elided and
automatically set; if an amount was elided, the final balance of all the
other postings is attributed to the balance.</p>
<p>With the <a href="../27_a_proposal_for_an_improvement_on_inventory_booking/"><span class="underline">inventory booking
proposal</span></a>,
it should be extended to be able to handle more cases of elision. An
interesting idea would be to allow the elided postings to at least
specify the currency they're using. This would allow the user to elide
multiple postings, like this:</p>
<pre><code>     2013-07-05 * "COMPANY INC PAYROLL"
       Assets:US:TD:Checking                                    USD
       Income:US:Company:GroupTermLife                   -25.38 USD
       Income:US:Company:Salary                        -5000.00 USD
       Assets:US:Vanguard:Cash                           540.00 USD
       Assets:US:Federal:IRAContrib                     -540.00 IRAUSD
       Expenses:Taxes:US:Federal:IRAContrib                     IRAUSD
       Assets:US:Company:Vacation                          4.62 VACHR
       Income:US:Company:Vacation                               VACHR
</code></pre>
<h3 id="stream-processing">Stream Processing<a class="headerlink" href="#stream-processing" title="Permanent link"></a></h3>
<p>An important by-product of representing all state using a single stream
of directives is that most of the operations in Beancount can be
implemented by simple functions that accept the list of directives as
input and output a modified list of directives.</p>
<p>For example,</p>
<ul>
<li>
<p>The “Pad” directive is implemented by processing the stream of
    transactions, accumulating balances, inserting a new padding
    transaction after the Pad directive when a balance assertion fails.</p>
</li>
<li>
<p><a href="http://bitbucket.org/blais/beancount/src/tip/src/python/beancount/ops/summarize.py"><span
    class="underline">Summarization</span></a>
    operations (open books, close books, clear net income to equity) are
    all implemented this way, as functional operators on the list of
    streams. For example, opening the books at a particular date is
    implemented by summing all balances before a certain date and
    replacing those transactions by new transactions that pull the final
    balance from an Equity account. Closing the books only involves
    moving the balances of income statement account to Equity and
    truncation the list of transactions to that date. This is very
    elegant—the reporting code can be oblivious to the fact that
    summarization has occurred.</p>
</li>
<li>
<p>Prices on postings held with a cost are normally ignored. The
    “implicit prices” option is implemented using a plugin which works
    its magic by processing the stream of operations and inserting
    otherwise banal Price directives automatically when such a posting
    is found.</p>
</li>
<li>
<p>Many types of verifications are also implemented this way; the
    <a href="https://bitbucket.org/blais/beancount/src/tip/src/python/beancount/plugins/sellgains.py"><span
    class="underline">sellgains</span></a>
    plugin verifies that non-income balances check against the converted
    price of postings disregarding the cost. This one does not insert
    any new directives, but may generate new errors.</p>
</li>
</ul>
<p>These are just some examples. I’m aiming to make most operations work
this way. This design has proved to be elegant, but also surprisingly
flexible and it has given birth to the plugins system available in
Beancount; you might be surprised to learn that I had not originally
thought to provide a plugins system... it just emerged over time teasing
abstractions and trying to avoid state in my program.</p>
<p><em>I am considering experimenting with weaving the errors within the
stream of directives by providing a new “Error” directive that could be
inserted by stream processing functions. I’m not sure whether this would
make anything simpler yet, it’s just an idea at this point [July
2015].</em></p>
<h3 id="stream-invariants">Stream Invariants<a class="headerlink" href="#stream-invariants" title="Permanent link"></a></h3>
<p>The stream of directives comes with a few guarantees you can rest upon:</p>
<ul>
<li>
<p>All the directives are ordered by date. Because many dates have
    multiple directives, in order to have a stable sorting order the
    line number in the file is used as a secondary sort key.</p>
</li>
<li>
<p>All uses of an account is preceded in the stream by a corresponding
    Open entry. If the input did not provide one, an Open directive is
    automatically synthesized.</p>
</li>
<li>
<p>All Balance directives precede any other directive on a particular
    day. This is enforced in order to make the processing of balance
    assertions straightforward and to emphasize that their semantics is
    to occur at the beginning of the day.</p>
</li>
</ul>
<h2 id="loader-processing-order">Loader &amp; Processing Order<a class="headerlink" href="#loader-processing-order" title="Permanent link"></a></h2>
<p>The process of <strong>loading</strong> a list of entries from an input file is the
heart of the project. It is important to understand it in order to
understand how Beancount works. Refer to the diagram below.</p>
<p><img src="media/d9525818c27bd84d2bd50e0e03d42a27eb597e2d.png" style="width:8.66667in;height:3.23611in" /></p>
<p>It consists of</p>
<ol>
<li>
<p>A <strong>parsing</strong> step that reads in all the input files and produces a
    stream of potentially incomplete directives.</p>
</li>
<li>
<p>The processing of this stream of entries by built-in and
    user-specified plugins. This step potentially produces new error
    objects.</p>
</li>
<li>
<p>A final validation step that ensures the invariants have not been
    broken by the plugins.</p>
</li>
</ol>
<p>The <a href="https://bitbucket.org/blais/beancount/src/tip/src/python/beancount/loader.py"><span
class="underline">beancount.loader</span></a>
module orchestrates this processing. <strong>In the code and documents, I’m
careful to distinguish between the terms “parsing” and “loading”
carefully.</strong> These two concepts are distinct. “Parsing” is only a part
of “loading.”</p>
<p>The user-specified plugins are run in the order they are provided in the
input files.</p>
<p><strong>Raw mode.</strong> Some users have expressed a desire for more control over
which built-in plugins are run and in which order they are to be run,
and so enabling the “raw” option disables the automatic loading of all
built-in plugins (you have to replace those with explicit “plugin”
directives if you want to do that). I’m not sure if this is going to be
useful yet, but it allows for tighter control over the loading process
for experimentation.</p>
<h3 id="loader-output">Loader Output<a class="headerlink" href="#loader-output" title="Permanent link"></a></h3>
<p>The parser and the loader produce three lists:</p>
<ul>
<li>
<p>entries: A list of directive tuples from beancount.core.data. This is the stream of data which should consists mostly of Transaction and Balance instances. As much as possible, all data transformations are performed by inserting or removing entries from this list. Throughout the code and documents, I refer to these as entries or directives interchangeably.</p>
</li>
<li>
<p>errors: A list of error objects. In Beancount I don’t use exceptions to report errors; rather, all the functions produce error objects and they are displayed at the most appropriate time. (These deserve a base common type but for now the convention they respect is that they all provide a source (filename, line-no), message and entry attributes.)</p>
</li>
<li>
<p>options_map: A dict of the options provided in the file and derived during parsing. Though this is a mutable object, we never modify it once produced by the parser.</p>
</li>
</ul>
<h2 id="parser-implementation">Parser Implementation<a class="headerlink" href="#parser-implementation" title="Permanent link"></a></h2>
<p>The Beancount parser is a mix of C and Python 3 code. This is the reason
you need to compile anything in the first place. The parser is
implemented in C using a <a href="http://flex.sourceforge.net/"><span
class="underline">flex</span></a> tokenizer
and a <a href="http://www.gnu.org/software/bison/"><span
class="underline">Bison</span></a>
parser generator, mainly for performance reasons.</p>
<p>I chose the C language and these crufty old <a href="https://www.gnu.org/"><span
class="underline">GNU</span></a> tools because they
are portable and will work everywhere. There are better parser
generators out there, but they would either require my users to install
more compiler tools or exotic languages. The C language is a great
common denominator. I want Beancount to work everywhere and to be easy
to install. I want this to make it easy on others, but I also want this
for myself, because at some point I’ll be working on other projects and
the less dependencies I have the lighter it will be to maintain aging
software. Just looking ahead. (That’s also why I chose to use Python
instead of some of the other languages I’m more naturally attracted to
these days (Clojure, Go, ML); I need Beancount to work... when I’m
counting the beans I don’t have time to debug problems. Python is
careful about its changes and it will be around for a long long time as
is.)</p>
<p>There is a lexer file lexer.l written in flex and a Bison grammar in
grammar.y. These tools are used to generate the corresponding C source
code (lexer.h/.c and grammar.h/.c). These, along with some hand-written
C code that defines some interface functions for the module
(parser.h/.c), are compiled into an extension module (_parser.so).</p>
<p>Eventually we could consider creating a small dependency rule in
setup.py to invoke flex and Bison automatically but at the moment, in
order to minimize the installation burden, I check the generated source
code in the repository (lexer.h/c and grammar.h/c).</p>
<p><img src="media/65eccfffba7aaf2e25a7f536d974f846d096ddcf.png" style="width:7.70833in;height:4.01389in" /></p>
<p>The interaction between the Python and C code works like this:</p>
<ul>
<li>
<p>You import beancount.parser.parser and invoke either parse_file()
    or parse_string(). This uses code in grammar.py to create a Builder
    object which essentially provides callbacks in Python to process
    grammar rules.</p>
</li>
<li>
<p>parser.py calls a C function in the extension module with the
    Builder object. That C code sets up flex to be able to read the
    input file or string then hands over control to the parser by
    calling the generated C function “yyparse()”.</p>
</li>
<li>
<p>yyparse() is the parser and will fetch input tokens from the lexer C
    code using successive calls to “yylex()” and attempt to reduce
    rules.</p>
</li>
<li>
<p>When a rule or token is successfully reduced, the C code invokes
    callback methods on the Builder object you provided. The parser’s
    rules communicate between each other by passing around “PyObject*”
    instances, so that code has to be a little careful about correctly
    handling reference counting. This allows me to run Python code on
    rule reduction, which makes it really easy to customize parser
    behaviour yet maintain the performance of the grammar rule
    processing in C.</p>
</li>
</ul>
<p>Note that the grammar.py Builder derives from a similar Builder class
defined in lexer.py, so that lexer tokens recognized calls methods
defined in the lexer.py file to create them and parser rule
correspondingly calls methods from grammar.py’s Builder. This isolation
is not only clean, it also makes it possible to just use the lexer to
tokenize a file from Python (without parsing) for testing the tokenizer;
see the tests where this is used if you’re curious how this works.</p>
<p>I just came up with this; I haven’t seen this done anywhere else. I
tried it and the faster parser made a huge difference compared to using
PLY so I stuck with that. I quite like the pattern, it’s a good
compromise that offers the flexibility of a parser generator yet allows
me to handle the rules using Python. Eventually I’d like to move just
some of the most important callbacks to C code in order to make this a
great deal faster (I haven’t done any real performance optimizations
yet).</p>
<p>This has worked well so far but for one thing: There are several
limitations inherent in the flex tokenizer that have proved problematic.
In particular, in order to recognize transaction postings using indent I
have had to tokenize the whitespace that occurs at the beginning of a
line. Also, single-characters in the input should be parsed as flags and
at the moment this is limited to a small subset of characters. I’d like
to eventually write a custom lexer with some lookahead capabilities to
better deal with these problems (this is easy to do).</p>
<h3 id="two-stages-of-parsing-incomplete-entries">Two Stages of Parsing: Incomplete Entries<a class="headerlink" href="#two-stages-of-parsing-incomplete-entries" title="Permanent link"></a></h3>
<p>At the moment, the parser produces transactions which may or may not
balance. The validation stage which runs after the plugins carries out
the balance assertions. This degree of freedom is allowed to provide the
opportunity for users to enter incomplete lists of postings and for
corresponding plugins to automate some data entry and insert completing
postings.</p>
<p>However, the postings on the transactions are always complete objects,
with all their expected attributes set. For example, a posting which has
its amount elided in the input syntax will have a filled in position by
the time it comes out of the parser.</p>
<p>We will have to loosen this property when we implement the <a href="../27_a_proposal_for_an_improvement_on_inventory_booking/"><span
class="underline">inventory booking
proposal</span></a>,
because we want to support the elision of numbers whose values depend on
the accumulated state of previous transactions. Here is an obvious
example. A posting like this</p>
<pre><code>2015-04-03 * "Sell stock"
  Assets:Investments:AAPL     -10 AAPL {}
  ...
</code></pre>
<p>should succeed if at the beginning of April 3rd the account contains
exactly 10 units of AAPL, in either a single or multiple lots. There is
no ambiguity: “sell all the AAPL,” this says. However, the fact of its
unambiguity assumes that we’ve computed the inventory balance of that
account up until April 3rd…</p>
<p>So the parser will need to be split into two phases:</p>
<ol>
<li>
<p>A simple parsing step that produces potentially incomplete entries
    with missing amounts</p>
</li>
<li>
<p>A separate step for the interpolation which will have available the
    inventory balances of each account as inputs. This second step is
    where the booking algorithms (e.g., FIFO) will be invoked from.</p>
</li>
</ol>
<p><img src="media/8ba8202797ee7206951b5913c9b3c264c33c7df0.png" style="width:6.05556in;height:3.01389in" /></p>
<p>See the diagram above for reference. Once implemented, everything else
should be the same.</p>
<h3 id="the-printer">The Printer<a class="headerlink" href="#the-printer" title="Permanent link"></a></h3>
<p>In the same package as the parser lives a printer. This isolates all the
functionality that deals with the Beancount “language” in the
beancount.parser package: the parser converts from input syntax to data
structure and the printer does the reverse. No code outside this package
should concern itself with the Beancount syntax.</p>
<p>At some point I decided to make sure that the printer was able to
round-trip through the parser, that is, given a stream of entries
produced by the loader, you should be able to convert those to text
input and parse them back in and the resulting set of entries should be
the same (outputting the re-read input back to text should produce the
same text), e.g.,</p>
<p><img src="media/22acb27dd9fa94cc4e32fa5ed449c155cf85c225.png" style="width:7.56944in;height:0.83333in" /></p>
<p>Note that the reverse isn’t necessarily true: reading an input file and
processing it through the loader potentially synthesizes a lot of
entries (thanks to the plugins), so printing it back may not produce the
same input file (even ignoring reordering and white space concerns).</p>
<p>This is a nice property to have. Among other things, it allows us to use
the parser to easily create tests with expected outputs. While there is
a test that attempts to protect this property, some of the recent
changes break it partially:</p>
<ul>
<li>
<p>Metadata round-tripping hasn’t been tested super well. In
    particular, some of the metadata fields need to be ignored (e.g.,
    filename and lineno).</p>
</li>
<li>
<p>Some directives contain derived data, e.g. the Balance directive has
    a “diff_amount” field that contains the difference when there is a
    failure in asserting a balance. This is used to report errors more
    easily. I probably need to remove these <a href="https://bitbucket.org/blais/beancount/src/24acbceb37aef8ab6bc6f324599fe434b7bad31c/src/python/beancount/core/compare.py?at=default#cl-14"><span
    class="underline">exceptions</span></a>
    at some point because it is the only one of its kind (I could
    replace it with an inserted “Error” directive).</p>
</li>
</ul>
<p>This probably needs to get refined a bit at some point with a more
complete test (it’s not far as it is).</p>
<h3 id="uniqueness-hashing">Uniqueness &amp; Hashing<a class="headerlink" href="#uniqueness-hashing" title="Permanent link"></a></h3>
<p>In order to make it possible to compare directives quickly, we support
unique hashing of all directives, that is, from each directive we should
be able to produce a short and unique id. We can then use these ids to
<a href="https://bitbucket.org/blais/beancount/src/tip/src/python/beancount/core/compare.py"><span class="underline">perform set inclusion/exclusion/comparison
tests</span></a>
for our unit tests. We provide a <a href="https://bitbucket.org/blais/beancount/src/tip/src/python/beancount/parser/cmptest.py"><span class="underline">base test case
class with assertion methods that use this
capability</span></a>.
This feature is used liberally throughout our test suites.</p>
<p>This is also used to detect and remove duplicates. This feature is
optional and enabled by the beancount.plugins.noduplicates plugin.</p>
<p>Note that the hashing of directives currently <a href="https://bitbucket.org/blais/beancount/src/24acbceb37aef8ab6bc6f324599fe434b7bad31c/src/python/beancount/core/compare.py?at=default#cl-14"><span
class="underline">does not include user
meta-data</span></a>.</p>
<h3 id="display-context">Display Context<a class="headerlink" href="#display-context" title="Permanent link"></a></h3>
<p>Number are input with different numbers of fractional digits:</p>
<pre><code>500    -&gt; 0 fractional digits
520.23 -&gt; 2 fractional digits
1.2357 -&gt; 4 fractional digits
31.462 -&gt; 3 fractional digits
</code></pre>
<p>Often, a number used for the same currency is input with a different
number of digits. Given this variation in the input, a question that
arises is <em>how to render the numbers consistently</em> in reports?</p>
<p>Consider that:</p>
<ul>
<li>
<p>We would like that the user not to have to specify the number of
    fractional digits to use for rendering by default.</p>
</li>
<li>
<p>Rendering numbers may differ depending on the context: most of the
    time we want to render numbers using their most commonly seen number
    of digits, rounding if necessary, but when we are rendering
    conversion rates we would like to render numbers using the maximum
    number of digits ever seen.</p>
</li>
</ul>
<!-- -->

<ul>
<li>
<p>The number of digits used tends to vary with the commodity they
    represent. For example, US dollars will usually render with two
    digits of precision; the number of units of a mutual fund such as
    RGAGX might be recorded by your broker with 3 digits of precision.
    Japanese Yen will usually be specified in integer units.</p>
</li>
<li>
<p>We want to render text report which need to align numbers with
    varying number of fractional digits together, aligning them by their
    period or rightmost digits, and possibly rendering a currency
    thereafter.</p>
</li>
</ul>
<p>In order to deal with this thorny problem, I built a kind of accumulator
which is used to record all numbers seen from some input and tally
statistics about the precisions witnessed for each currency. I call this
a <a href="https://bitbucket.org/blais/beancount/src/tip/src/python/beancount/core/display_context.py"><span
class="underline">DisplayContext</span></a>.
From this object one can request to build a DisplayFormatter object
which can be used to render numbers in a particular way.</p>
<p>I refer to those objects using the variable names dcontext and dformat
throughout the code. The parser automatically creates a DisplayContext
object and feeds it all the numbers it sees during parsing. The object
is available in the options_map produced by the loader.</p>
<h2 id="realization">Realization<a class="headerlink" href="#realization" title="Permanent link"></a></h2>
<p>It occurs often that one needs to compute the final balances of a list
of filtered transactions, and to report on them in a hierarchical
account structure. See diagram below.</p>
<h2 id="_1"><img src="media/736b05ad5dbed8af111f3f9d01d38b8b99914e7b.png" style="width:8.66667in;height:3.06944in" /><a class="headerlink" href="#_1" title="Permanent link"></a></h2>
<p>For the purpose of creating hierarchical renderings, I provide a process
called a “<a href="https://bitbucket.org/blais/beancount/src/tip/src/python/beancount/core/realization.py"><span
class="underline">realization</span></a>.”
A realization is a tree of nodes, each of which contains</p>
<ul>
<li>
<p>An account name,</p>
</li>
<li>
<p>A list of postings and other entries to that account, and</p>
</li>
<li>
<p>The final balance for that account,</p>
</li>
<li>
<p>A mapping of sub-account names to child nodes.</p>
</li>
</ul>
<p>The nodes are of type “RealAccount,” which is also a dict of its
children. All variables of type RealAccount in the codebase are by
convention prefixed by “real_*”. The <a href="https://bitbucket.org/blais/beancount/src/tip/src/python/beancount/core/realization.py"><span
class="underline">realization</span></a>
module provides functions to iterate and produce hierarchical reports on
these trees of balances, and the reporting routines all use these.</p>
<p>For example, here is a bit of code that will dump a tree of balances of
your accounts to the console:</p>
<pre><code>import sys
from beancount import loader
from beancount.core import realization

entries, errors, options_map = loader.load_file("filename.beancount")
real_root = realization.realize(entries)
realization.dump_balances(real_root, file=sys.stdout)
</code></pre>
<h2 id="the-web-interface">The Web Interface<a class="headerlink" href="#the-web-interface" title="Permanent link"></a></h2>
<p>Before the appearance of the SQL syntax to filter and aggregate
postings, the only report produced by Beancount was the web interface
provide by bean-web. As such, bean-web evolved to be good enough for
most usage and general reports.</p>
<h3 id="reports-vs-web">Reports vs. Web<a class="headerlink" href="#reports-vs-web" title="Permanent link"></a></h3>
<p>One of the important characteristics of bean-web is that it should just
be a thin dispatching shell that serves reports generated from the
<a href="https://bitbucket.org/blais/beancount/src/tip/src/python/beancount/reports/"><span
class="underline">beancount.reports</span></a>
layer. It used to contain the report rendering code itself, but at some
point I began to factor out all the reporting code to a separate package
in order to produce reports to other formats, such as text reports and
output to CSV. This is mostly finished, but at this time [July 2015]
some reports remain that only support HTML output. This is why.</p>
<h3 id="client-side-javascript">Client-Side JavaScript<a class="headerlink" href="#client-side-javascript" title="Permanent link"></a></h3>
<p>I would like to eventually include a lot more client-side scripting in
the web interface. However, I don’t think I’ll be able to work on this
for a while, at least not until all the proposals for changes to the
core are complete (e.g., inventory booking improvements, settlement
splitting and merging, etc.).</p>
<p>If you’d like to contribute to Beancount, improving bean-web or creating
your own visualizations would be a great venue.</p>
<h2 id="the-query-interface">The Query Interface<a class="headerlink" href="#the-query-interface" title="Permanent link"></a></h2>
<p>The current query interface is the result of a <em>prototype</em>. It has not
yet been subjected to the amount of testing and refinement as the rest
of the codebase. I’ve been experimenting with it and have a lot of ideas
for improving the SQL language and the kinds of outputs that can be
produced from it. I think of it as “70% done”.</p>
<p>However, it works, and though some of the reports can be a little clunky
to specify, it produces useful results.</p>
<p>It will be the subject of a complete rewrite at some point and when I
do, I will keep the current implementation for a little while so that
existing scripts don’t just break; I’ll implement a v2 of the shell.</p>
<h2 id="design-principles">Design Principles<a class="headerlink" href="#design-principles" title="Permanent link"></a></h2>
<h3 id="minimize-configurability">Minimize Configurability<a class="headerlink" href="#minimize-configurability" title="Permanent link"></a></h3>
<p>First, Beancount should have as few options as possible. Second,
command-line programs should have no options that pertain to the
processing and semantic of the input file (options that affect the
output or that pertain to the script itself are fine).</p>
<p>The goal is to avoid feature creep. Just a few options opens the
possibility of them interacting in complex ways and raises a lot of
questions. In this project, instead of providing options to customize
every possible thing, I choose to bias the design towards providing the
best behavior by default, even if that means less behavior. This is the
Apple approach to design. I don’t usually favor this approach for my
projects, but I chose it for this particular one. What I’ve learned in
the process is how far you can get and still provide much of the
functionality you originally set out for.</p>
<p>Too many command-line options makes a program difficult to use. I think
Ledger suffers from this, for instance. I can never remember options
that I don’t use regularly, so I prefer to just design without them.
Options that affect semantics should live in the file itself (and should
be minimized as well). Options provided when running a process should be
only to affect this process.</p>
<p>Having less options also makes the software much easier to refactor. The
main obstacle to evolving a library of software is the number of complex
interactions between the codes. Guaranteeing a well-defined set of
invariants makes it much easier to later on split up functionality or
group it differently.</p>
<p>So.. by default I will resist making changes that aren't generic or that
would not work for most users. On the other hand, large-scale changes
that would generalize well and that require little configurability are
more likely to see implementation.</p>
<h3 id="favor-code-over-dsls">Favor Code over DSLs<a class="headerlink" href="#favor-code-over-dsls" title="Permanent link"></a></h3>
<p>Beancount provides a simple syntax, a parser and printer for it, and a
library of very simple data record types to allow a user to easily write
their scripts to process their data, taking advantage of the multitude
of libraries available from the Python environment. Should the built-in
querying tools fail to suffice, I want it to be trivially easy for
someone to build what they need on top of Beancount.</p>
<p>This also means that the tools provided by Beancount don’t have to
support <em>all</em> the features everyone might ever possibly want.
Beancount’s strength should be representational coherence and simplicity
rather the richness of its reporting features. Creating new kinds of
reports should be easy; changing the internals should be hard. (That
said, it does provide an evolving palette of querying utilities that
should be sufficient for most users.)</p>
<p>In contrast, the implementation of the Ledger system provides high-level
operations that are invoked as "expressions" defined in a
domain-specific language, expressions which are either provided on the
command-line or in the input file itself. For the user, this expression
language is yet another thing to learn, and it’s yet another thing that
might involve limitations require expansion and work… I prefer to avoid
DSLs if possible and use Python’s well understood semantics instead,
though this is not always sensible.</p>
<h3 id="file-format-or-input-language">File Format or Input Language?<a class="headerlink" href="#file-format-or-input-language" title="Permanent link"></a></h3>
<p>One may wonder whether Beancount’s input syntax should be a computer
language or just a data format. The problem we're trying to solve is
essentially that of making it easy for a human being to create a
transactions-to-postings-to-accounts-&amp;-positions data structure.</p>
<p>What is the difference between a data file format and a simple
declarative computer language?</p>
<p>One distinction is the intended writer of the file. Is it a human? Or is
it a computer? The input files are meant to be manicured by a human, at
the very least briefly eyeballed. While we are trying to automate as
much of this process as possible via importing code—well, the unpleasant
bits, anyway—we do want to insure that we review all the new
transactions that we're adding to the ledger in order to ensure
correctness. If the intended writer is a human one could file the input
under the computer language rubric (most data formats are designed to be
written by computers).</p>
<p>We can also judge it by the power of its semantics. Beancount’s language
is not one designed to be used to perform computation, that is, you
cannot define new “Beancount functions” in it. But it has data types. In
this regard, it is more like a file format.</p>
<p>Just something to think about, especially in the context of adding new
semantics.</p>
<h3 id="grammar-via-parser-generator">Grammar via Parser Generator<a class="headerlink" href="#grammar-via-parser-generator" title="Permanent link"></a></h3>
<p>The grammar of its language should be compatible with the use of
commonly used parser generator tools. It should be possible to parse the
language with a simple lexer and some grammar input file.</p>
<p>Beancount’s original syntax was modeled after the syntax of Ledger.
However, in its attempt to make the amount of markup minimal, that
syntax is difficult to parse with regular tools. By making simple
changes to the grammar, e.g. adding tokens for strings and accounts and
commodities, the Beancount v2 reimplementation made it possible to use a
flex/bison parser generator.</p>
<p>This has important advantages:</p>
<ul>
<li>
<p>It makes it really easy to make incremental changes to the grammar.
    Using a custom parser without a well-defined grammar can make it
    quite difficult to prototype syntax changes.</p>
</li>
<li>
<p>It makes it much easier to implement a parser in another computer
    language. I’d like to eventually be able to parse Beancount input
    files in other languages. The data structures are simple enough that
    it should be easy to reimplement the core in a different language.</p>
</li>
<li>
<p>It’s just a lot less code to write and maintain.</p>
</li>
</ul>
<p>(Eventually I’d like to create a file format to generate parsers in
multiple languages from a single input. That will be done later, once
all the major features are implemented.)</p>
<h2 id="future-work">Future Work<a class="headerlink" href="#future-work" title="Permanent link"></a></h2>
<h3 id="tagged-strings">Tagged Strings<a class="headerlink" href="#tagged-strings" title="Permanent link"></a></h3>
<p>At the moment, account names, tags, links and commodities are
represented as simple Python strings. I’ve tried to keep things simple.
At some point I’d like to refine this a bit and create a specialization
of strings for each of these types. I’d need to assess the performance
impact of doing that beforehand. I’m not entirely sure how it could
benefit functionality yet.</p>
<h3 id="errors-cleanup">Errors Cleanup<a class="headerlink" href="#errors-cleanup" title="Permanent link"></a></h3>
<p>I’ve been thinking about removing the separate “errors” list and
integrating it into the stream of entries as automatically produced
“Error” entries. This has the advantage that the errors could be
rendered as part of the rest of the stream, but it means we have to
process the whole list of entries any time we need to print and find
errors (probably not a big deal, given how rarely we output errors).</p>
<h3 id="types">Types<a class="headerlink" href="#types" title="Permanent link"></a></h3>
<p>Python 3.5 introduces types. I plan to use that throughout Beancount
sometime after 3.5 is released, and I hope for it to catch a different
class of errors than I’m already handling by unit tests.</p>
<h2 id="conclusion">Conclusion<a class="headerlink" href="#conclusion" title="Permanent link"></a></h2>
<p>This document is bound to evolve. If you have questions about the
internals, please post them to the <a href="http://furius.ca/beancount/doc/mailing-list"><span
class="underline">mailing-list</span></a>.</p>
<h2 id="references">References<a class="headerlink" href="#references" title="Permanent link"></a></h2>
<p>Nothing in Beancount is inspired from the following docs, but you may
find them interesting as well:</p>
<ul>
<li><a href="http://martin.kleppmann.com/2011/03/07/accounting-for-computer-scientists.html"><span class="underline">Accounting for Computer
    Scientists</span></a></li>
</ul>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>I have been considering the addition of a very constrained form of
non-balancing postings that would preserve the property of
transactions otherwise being balanced, whereby the extra postings
would not be able to interact (or sum with) regular balancing
postings.&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>There is an option called “operating_currency” but it is only
used to provide good defaults for building reports, never in the
processing of transactions. It is used to tell the reporting code
which commodities should be broken out to have their own columns of
balances, for example.&#160;<a class="footnote-backref" href="#fnref:2" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:3">
<p>In previous version of Beancount this was not true, the Posting
used to have a ‘position’ attribute and composed it. I prefer the
flattened design, as many of the functions apply to either a
Position or a Posting. Think of a Posting as <em>deriving</em> from a
Position, though, technically it does not.&#160;<a class="footnote-backref" href="#fnref:3" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
</ol>
</div></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
